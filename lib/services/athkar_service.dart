// lib/services/athkar_service.dart
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:test_athkar_app/models/athkar_model.dart';

class AthkarService {
  // singleton pattern
  static final AthkarService _instance = AthkarService._internal();
  factory AthkarService() => _instance;
  AthkarService._internal();

  // البيانات المؤقتة للأذكار (سيتم استبدالها بالبيانات الحقيقية من ملف JSON)
  List<AthkarCategory> _defaultCategories = [
    AthkarCategory(
      id: 'morning',
      title: 'أذكار الصباح',
      icon: Icons.wb_sunny,
      color: const Color(0xFF4CAF50),
      description: 'الأذكار التي تقال في الصباح بعد صلاة الفجر حتى الضحى',
      athkar: [
        Thikr(
          text: 'أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَـهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ.',
          count: 1,
          source: 'أبو داود',
        ),
        Thikr(
          text: 'اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ.',
          fadl: 'من قالها موقنا بها حين يمسي ومات من ليلته دخل الجنة وكذلك حين يصبح.',
          count: 1,
          source: 'البخاري',
        ),
        Thikr(
          text: 'اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي وَدُنْيَايَ وَأَهْلِي وَمَالِي، اللَّهُمَّ اسْتُرْ عَوْرَاتِي وَآمِنْ رَوْعَاتِي.',
          count: 1,
          source: 'أبو داود وابن ماجه',
        ),
        Thikr(
          text: 'أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ.',
          fadl: 'من قالها ثلاث مرات حين يمسي لم تضره حمة تلك الليلة.',
          count: 3,
          source: 'الترمذي',
        ),
        Thikr(
          text: 'بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ.',
          fadl: 'من قالها ثلاث مرات حين يصبح وثلاث مرات حين يمسي لم يضره شيء.',
          count: 3,
          source: 'أبو داود والترمذي',
        ),
        Thikr(
          text: 'اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ النُّشُورُ.',
          count: 1,
          source: 'الترمذي',
        ),
        Thikr(
          text: 'سُبْحَانَ اللَّهِ وَبِحَمْدِهِ.',
          fadl: 'من قالها مائة مرة حين يصبح وحين يمسي لم يأت أحد يوم القيامة بأفضل مما جاء به إلا أحد قال مثل ما قال أو زاد عليه.',
          count: 100,
          source: 'مسلم',
        ),
      ],
    ),
    AthkarCategory(
      id: 'evening',
      title: 'أذكار المساء',
      icon: Icons.nightlight_round,
      color: const Color(0xFF2196F3),
      description: 'الأذكار التي تقال في المساء بعد صلاة العصر حتى صلاة العشاء',
      athkar: [
        Thikr(
          text: 'أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَـهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ.',
          count: 1,
          source: 'أبو داود',
        ),
        Thikr(
          text: 'اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ.',
          fadl: 'من قالها موقنا بها حين يمسي ومات من ليلته دخل الجنة وكذلك حين يصبح.',
          count: 1,
          source: 'البخاري',
        ),
        Thikr(
          text: 'اللَّهُمَّ إِنِّي أَمْسَيْتُ أُشْهِدُكَ، وَأُشْهِدُ حَمَلَةَ عَرْشِكَ، وَمَلَائِكَتَكَ، وَجَمِيعَ خَلْقِكَ، أَنَّكَ أَنْتَ اللهُ لَا إِلَهَ إِلَّا أَنْتَ وَحْدَكَ لَا شَرِيكَ لَكَ، وَأَنَّ مُحَمَّدًا عَبْدُكَ وَرَسُولُكَ.',
          fadl: 'من قالها أعتقه الله من النار.',
          count: 4,
          source: 'أبو داود',
        ),
        Thikr(
          text: 'أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ.',
          fadl: 'من قالها ثلاث مرات حين يمسي لم تضره حمة تلك الليلة.',
          count: 3,
          source: 'الترمذي',
        ),
        Thikr(
          text: 'اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْهَمِّ وَالْحَزَنِ، وَأَعُوذُ بِكَ مِنَ الْعَجْزِ وَالْكَسَلِ، وَأَعُوذُ بِكَ مِنَ الْجُبْنِ وَالْبُخْلِ، وَأَعُوذُ بِكَ مِنْ غَلَبَةِ الدَّيْنِ، وَقَهْرِ الرِّجَالِ.',
          count: 1,
          source: 'البخاري',
        ),
        Thikr(
          text: 'اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ الْمَصِيرُ.',
          count: 1,
          source: 'الترمذي',
        ),
      ],
    ),
    AthkarCategory(
      id: 'sleep',
      title: 'أذكار النوم',
      icon: Icons.bedtime,
      color: const Color(0xFF3F51B5),
      description: 'الأذكار التي تقال عند النوم',
      athkar: [
        Thikr(
          text: 'بِاسْمِكَ اللَّهُمَّ أَمُوتُ وَأَحْيَا.',
          count: 1,
          source: 'البخاري',
        ),
        Thikr(
          text: 'اللَّهُمَّ قِنِي عَذَابَكَ يَوْمَ تَبْعَثُ عِبَادَكَ.',
          count: 3,
          source: 'أبو داود والترمذي',
        ),
        Thikr(
          text: 'سُبْحَانَ اللَّهِ.',
          count: 33,
          source: 'متفق عليه',
        ),
        Thikr(
          text: 'الْحَمْدُ لِلَّهِ.',
          count: 33,
          source: 'متفق عليه',
        ),
        Thikr(
          text: 'اللَّهُ أَكْبَرُ.',
          count: 34,
          source: 'متفق عليه',
        ),
      ],
    ),
    AthkarCategory(
      id: 'wake',
      title: 'أذكار الاستيقاظ',
      icon: Icons.alarm,
      color: const Color(0xFFFF9800),
      description: 'الأذكار التي تقال عند الاستيقاظ من النوم',
      athkar: [
        Thikr(
          text: 'الْحَمْدُ لِلَّهِ الَّذِي أَحْيَانَا بَعْدَ مَا أَمَاتَنَا وَإِلَيْهِ النُّشُورُ.',
          count: 1,
          source: 'البخاري',
        ),
        Thikr(
          text: 'لَا إِلَهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، سُبْحَانَ اللَّهِ، وَالْحَمْدُ لِلَّهِ، وَلَا إِلَهَ إِلَّا اللهُ، وَاللهُ أَكْبَرُ، وَلَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللَّهِ الْعَلِيِّ الْعَظِيمِ، رَبِّ اغْفِرْ لِي.',
          count: 1,
          source: 'البخاري',
        ),
      ],
    ),
    AthkarCategory(
      id: 'prayer',
      title: 'أذكار الصلاة',
      icon: Icons.mosque,
      color: const Color(0xFF795548),
      description: 'الأذكار التي تقال بعد الصلاة',
      athkar: [
        Thikr(
          text: 'أَسْتَغْفِرُ اللَّهَ (ثلاثاً) اللَّهُمَّ أَنْتَ السَّلَامُ، وَمِنْكَ السَّلَامُ، تَبَارَكْتَ يَا ذَا الْجَلَالِ وَالْإِكْرَامِ.',
          count: 1,
          source: 'مسلم',
        ),
        Thikr(
          text: 'لَا إِلَهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، اللَّهُمَّ لَا مَانِعَ لِمَا أَعْطَيْتَ، وَلَا مُعْطِيَ لِمَا مَنَعْتَ، وَلَا يَنْفَعُ ذَا الْجَدِّ مِنْكَ الْجَدُّ.',
          count: 1,
          source: 'متفق عليه',
        ),
        Thikr(
          text: 'سُبْحَانَ اللَّهِ.',
          count: 33,
          source: 'مسلم',
        ),
        Thikr(
          text: 'الْحَمْدُ لِلَّهِ.',
          count: 33,
          source: 'مسلم',
        ),
        Thikr(
          text: 'اللَّهُ أَكْبَرُ.',
          count: 33,
          source: 'مسلم',
        ),
        Thikr(
          text: 'لَا إِلَهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ.',
          fadl: 'من قالها بعد كل صلاة مكتوبة غفرت خطاياه وإن كانت مثل زبد البحر.',
          count: 1,
          source: 'مسلم',
        ),
        Thikr(
          text: 'قُلْ هُوَ اللَّهُ أَحَدٌ ... (الإخلاص)، قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ ... (الفلق)، قُلْ أَعُوذُ بِرَبِّ النَّاسِ ... (الناس).',
          count: 1,
          source: 'أبو داود والترمذي والنسائي',
        ),
        Thikr(
          text: 'لَا إِلَهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ يُحْيِي وَيُمِيتُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ.',
          count: 10,
          fadl: 'من قالها بعد المغرب والصبح عشر مرات، كتب الله له بكل واحدة قالها عشر حسنات، ومحا عنه عشر سيئات، ورفع له عشر درجات، وكانت له حرزاً من الشيطان، ولم ينبغ لذنب أن يدركه إلا الشرك بالله، وكان من أفضل الناس عملاً إلا رجل يفضله.',
          source: 'الترمذي',
        ),
      ],
    ),
    AthkarCategory(
      id: 'home',
      title: 'أذكار المنزل',
      icon: Icons.home,
      color: const Color(0xFF009688),
      description: 'الأذكار التي تقال عند دخول المنزل والخروج منه',
      athkar: [
        Thikr(
          text: 'بِسْمِ اللَّهِ وَلَجْنَا، وَبِسْمِ اللَّهِ خَرَجْنَا، وَعَلَى رَبِّنَا تَوَكَّلْنَا.',
          count: 1,
          source: 'أبو داود',
        ),
        Thikr(
          text: 'اللَّهُمَّ إِنِّي أَسْأَلُكَ خَيْرَ الْمَوْلِجِ وَخَيْرَ الْمَخْرَجِ، بِسْمِ اللَّهِ وَلَجْنَا، وَبِسْمِ اللَّهِ خَرَجْنَا، وَعَلَى اللَّهِ رَبِّنَا تَوَكَّلْنَا.',
          count: 1,
          source: 'أبو داود',
        ),
      ],
    ),
    AthkarCategory(
      id: 'food',
      title: 'أذكار الطعام',
      icon: Icons.restaurant,
      color: const Color(0xFFE91E63),
      description: 'الأذكار التي تقال قبل الطعام وبعده',
      athkar: [
        Thikr(
          text: 'بِسْمِ اللَّهِ.',
          count: 1,
          source: 'أبو داود والترمذي',
        ),
        Thikr(
          text: 'بِسْمِ اللَّهِ فِي أَوَّلِهِ وَآخِرِهِ.',
          fadl: 'إذا نسي أن يذكر اسم الله في أول الطعام.',
          count: 1,
          source: 'أبو داود والترمذي',
        ),
        Thikr(
          text: 'الْحَمْدُ لِلَّهِ الَّذِي أَطْعَمَنِي هَذَا، وَرَزَقَنِيهِ، مِنْ غَيْرِ حَوْلٍ مِنِّي وَلَا قُوَّةٍ.',
          fadl: 'من قاله غفر له ما تقدم من ذنبه.',
          count: 1,
          source: 'أبو داود والترمذي',
        ),
        Thikr(
          text: 'الْحَمْدُ لِلَّهِ حَمْدًا كَثِيرًا طَيِّبًا مُبَارَكًا فِيهِ، غَيْرَ مَكْفِيٍّ وَلَا مُوَدَّعٍ، وَلَا مُسْتَغْنًى عَنْهُ رَبَّنَا.',
          count: 1,
          source: 'البخاري',
        ),
      ],
    ),
    AthkarCategory(
      id: 'quran',
      title: 'أدعية قرآنية',
      icon: Icons.menu_book,
      color: const Color(0xFF673AB7),
      description: 'أدعية من القرآن الكريم',
      athkar: [
        Thikr(
          text: 'رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ.',
          count: 1,
          source: 'البقرة: 201',
        ),
        Thikr(
          text: 'رَبَّنَا لَا تُؤَاخِذْنَا إِنْ نَسِينَا أَوْ أَخْطَأْنَا، رَبَّنَا وَلَا تَحْمِلْ عَلَيْنَا إِصْرًا كَمَا حَمَلْتَهُ عَلَى الَّذِينَ مِنْ قَبْلِنَا، رَبَّنَا وَلَا تُحَمِّلْنَا مَا لَا طَاقَةَ لَنَا بِهِ، وَاعْفُ عَنَّا وَاغْفِرْ لَنَا وَارْحَمْنَا، أَنْتَ مَوْلَانَا فَانْصُرْنَا عَلَى الْقَوْمِ الْكَافِرِينَ.',
          count: 1,
          source: 'البقرة: 286',
        ),
        Thikr(
          text: 'رَبَّنَا لَا تُزِغْ قُلُوبَنَا بَعْدَ إِذْ هَدَيْتَنَا وَهَبْ لَنَا مِنْ لَدُنْكَ رَحْمَةً إِنَّكَ أَنْتَ الْوَهَّابُ.',
          count: 1,
          source: 'آل عمران: 8',
        ),
        Thikr(
          text: 'رَبَّنَا اغْفِرْ لَنَا ذُنُوبَنَا وَإِسْرَافَنَا فِي أَمْرِنَا وَثَبِّتْ أَقْدَامَنَا وَانْصُرْنَا عَلَى الْقَوْمِ الْكَافِرِينَ.',
          count: 1,
          source: 'آل عمران: 147',
        ),
        Thikr(
          text: 'رَبَّنَا مَا خَلَقْتَ هَذَا بَاطِلًا سُبْحَانَكَ فَقِنَا عَذَابَ النَّارِ.',
          count: 1,
          source: 'آل عمران: 191',
        ),
      ],
    ),
  ];

  // قائمة فئات الأذكار
  List<AthkarCategory> get categories => _defaultCategories;

  // الحصول على فئة معينة
  AthkarCategory? getCategoryById(String id) {
    try {
      return _defaultCategories.firstWhere((cat) => cat.id == id);
    } catch (e) {
      return null;
    }
  }

  // تحديث عداد الذكر
  Future<void> updateThikrCount(String categoryId, int thikrIndex, int newCount) async {
    final prefs = await SharedPreferences.getInstance();
    final key = 'thikr_count_${categoryId}_$thikrIndex';
    await prefs.setInt(key, newCount);
  }

  // استعادة عداد الذكر المحفوظ
  Future<int> getThikrCount(String categoryId, int thikrIndex) async {
    final prefs = await SharedPreferences.getInstance();
    final key = 'thikr_count_${categoryId}_$thikrIndex';
    return prefs.getInt(key) ?? 0;
  }

  // إضافة ذكر إلى المفضلة
  Future<void> toggleFavorite(String categoryId, int thikrIndex) async {
    final prefs = await SharedPreferences.getInstance();
    final key = 'thikr_favorite_${categoryId}_$thikrIndex';
    final isFavorite = prefs.getBool(key) ?? false;
    await prefs.setBool(key, !isFavorite);
  }

  // التحقق مما إذا كان الذكر مفضلاً
  Future<bool> isFavorite(String categoryId, int thikrIndex) async {
    final prefs = await SharedPreferences.getInstance();
    final key = 'thikr_favorite_${categoryId}_$thikrIndex';
    return prefs.getBool(key) ?? false;
  }
}